variables:
  PYTHONPATH: "${CI_PROJECT_DIR}/src"
  ECR_REPOSITORY: 598791268315.dkr.ecr.us-east-2.amazonaws.com/danieluclsdockerrepository
  IMAGE_TAG: ${CI_COMMIT_REF_SLUG}-${CI_COMMIT_SHORT_SHA}

stages:
  - lint
  - test
  - deploy
  - trigger

lint:
  stage: lint
  image: python:3.10
  script:
    - python3 -V  # Print out python version for debugging
    - python3 -m pip install --upgrade pip
    - python3 -m pip install black
    - python3 -m black --check .

test:
  stage: test
  image: python:3.10
  script:
    - python3 -m pip install --upgrade pip
    - python3 -m pip install pytest pytest-cov boto3 numpy pandas numpy-stl
    - python3 -m pytest --cov=aws_src_sample --cov-report term --cov-report=xml:coverage.xml
  coverage: '/(?i)total.*? (100(?:\.0+)?\%|[1-9]?\d(?:\.\d+)?\%)$/'

deploy:
  stage: deploy
  image: docker:19.03.12
  services:
    - docker:19.03.12-dind
  script:
    - apk add --no-cache python3 py3-pip
    - pip3 install awscli
    - docker build -t ${ECR_REPOSITORY}:${IMAGE_TAG} .
    - docker tag ${ECR_REPOSITORY}:${IMAGE_TAG} ${ECR_REPOSITORY}:latest
    - aws ecr get-login-password --region ${AWS_DEFAULT_REGION} | docker login --username AWS --password-stdin ${ECR_REPOSITORY}
    - docker push ${ECR_REPOSITORY}:latest  # Intentionally only have a single, latest image for $$$ sake
  only:
    - main

trigger:
  stage: trigger
  image: python:3.10
  script:
    - curl --request POST --form token=${INFRA_TRIGGER_TOKEN} --form ref=main "https://gitlab.com/api/v4/projects/53267064/trigger/pipeline"
